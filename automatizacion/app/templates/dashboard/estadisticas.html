{% extends "layout.html" %}
{% block title %}EstadÃ­sticas{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-center">ðŸ“Š EstadÃ­sticas Generales</h2>

  {% if data.resumen %}
  <div class="row g-4 mb-4">
    <div class="col-md-3"><div class="card text-bg-primary"><div class="card-body"><h5>Total Usuarios</h5><p class="h3">{{ data.resumen.total_usuarios }}</p></div></div></div>
    <div class="col-md-3"><div class="card text-bg-success"><div class="card-body"><h5>Total Dispositivos</h5><p class="h3">{{ data.resumen.total_dispositivos }}</p></div></div></div>
    <div class="col-md-3"><div class="card text-bg-danger"><div class="card-body"><h5>Riesgos CrÃ­ticos</h5><p class="h3">{{ data.resumen.riesgos_criticos }}</p></div></div></div>
    <div class="col-md-3"><div class="card text-bg-warning"><div class="card-body"><h5>Riesgos Medios</h5><p class="h3">{{ data.resumen.riesgos_medios }}</p></div></div></div>
  </div>
  {% endif %}
<div class="row mb-6">
  <div class="col-md-4">
  <h4 class="mt-4">ðŸ“ˆ Actividad por Usuario</h4>
  <canvas id="actividadChart" height="300"></canvas>
  </div>
  <div class="col-md-4">
    <h4 class="mt-5">ðŸ“Š Riesgo General</h4>
  <canvas id="riesgoChart" height="5" ></canvas>
  </div>
</div>
  <h4 class="mt-5">ðŸ“‹ Detalle por Usuario</h4>
  <div class="table-responsive mt-3">
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>Usuario</th>
          <th>Ãšltimas Actividades</th>
          <th>Dispositivos</th>
          <th>Riesgo</th>
        </tr>
      </thead>
      <tbody>
        {% for u, stats in data.usuarios.items() %}
        <tr>
          <td>{{ u }}</td>
          <td>{{ stats.ultimas_actividades }}</td>
          <td>{{ stats.dispositivos }}</td>
          <td>
            {% if stats.riesgo > 2 %}
              <span class="badge bg-danger">Alto</span>
            {% elif stats.riesgo > 0 %}
              <span class="badge bg-warning">Medio</span>
            {% else %}
              <span class="badge bg-success">Bajo</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script>
  const labels = {{ data.usuarios.keys() | list | tojson }};
  const actividades = {{ data.usuarios.values() | map(attribute="ultimas_actividades") | list | tojson }};
  const dispositivos = {{ data.usuarios.values() | map(attribute="dispositivos") | list | tojson }};
  
  // GrÃ¡fico de barras: actividad por usuario
  new Chart(document.getElementById("actividadChart"), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: "Actividades",
        data: actividades,
        backgroundColor: 'rgba(54, 162, 235, 0.7)'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });

  // GrÃ¡fico de pastel: riesgos
  const riesgoChart = new Chart(document.getElementById('riesgoChart'), {
    type: 'pie',
    data: {
      labels: ['CrÃ­tico', 'Medio', 'Bajo'],
      datasets: [{
        data: [
          {{ data.resumen.riesgos_criticos }},
          {{ data.resumen.riesgos_medios }},
          {{ data.resumen.riesgos_bajos }}
        ],
        backgroundColor: [
          'rgba(220, 53, 69, 0.8)',
          'rgba(255, 193, 7, 0.8)',
          'rgba(25, 135, 84, 0.8)'
        ]
      }]
    },
    options: {
      responsive: true
    }
  });
</script>
{% endblock %}

